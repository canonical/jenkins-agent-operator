#!/bin/bash

# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.

err() {
  echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*" >&2
}

info() {
   echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $*"
}

stop() {
    snapctl stop jenkins-agent
    exit 1
}

set -eu -o pipefail

export LC_ALL=C
export TERM=xterm

. "$SNAP/bin/management"

# readonly JENKINS_HOME="/var/lib/jenkins"
# readonly JENKINS_HOME="/home/var/lib/jenkins"
# readonly JENKINS_HOME="/media/var/lib/jenkins"
readonly JENKINS_HOME="/var/snap/jenkins-agent/common/agent"


if ! mkdir -p $JENKINS_HOME; then
    err "Error initializing the agent's home directory"
    # err "The snap might not be connected to the :home interface"
    # err "Run snap connect jenkins-agent:home :home"
    stop
fi
cd $JENKINS_HOME

# fetch snap configuration
JENKINS_URL="$(jenkins_url)"
JENKINS_AGENT="$(jenkins_agent)"
JENKINS_TOKEN="$(jenkins_token)"

if [[ "${JENKINS_URL}" == "unset" || "${JENKINS_AGENT}" == "unset" || "${JENKINS_TOKEN}" == "unset" ]]; then
    if [[ "${JENKINS_URL}" == "unset" ]]; then
        err "JENKINS_URL needs to be configured"
    fi
    if [[ "${JENKINS_AGENT}" == "unset" ]]; then
        err "JENKINS_AGENT needs to be configured"
    fi
    if [[ "${JENKINS_TOKEN}" == "unset" ]]; then
        err "JENKINS_TOKEN needs to be configured"
    fi
    err "Invalid configuration, missing value(s)"
    stop
fi

if ! curl "${JENKINS_URL}/jnlpJars/agent.jar" -o ${JENKINS_HOME}/agent.jar; then
    err Unable to download agent binary
    stop
fi

# Specify the agent as ready
touch $JENKINS_HOME/.ready
if ! java -jar agent.jar -jnlpUrl "${JENKINS_URL}/computer/${JENKINS_AGENT}/slave-agent.jnlp" -workDir "${JENKINS_HOME}" -noReconnect -secret "${JENKINS_TOKEN}"; then
    err "Error connecting to jenkins"
    # Remove ready mark if unsuccessful
    rm $JENKINS_HOME/.ready
    stop
fi
